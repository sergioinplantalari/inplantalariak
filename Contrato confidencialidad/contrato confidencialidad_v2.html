<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato de Confidencialidad (NDA)</title>
    <!-- Tailwind CSS CDN para modernizar la estructura y el dise√±o responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'legal-blue': '#3498db',
                        'dark-bg': '#2c3e50',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base manteniendo el look and feel legal */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            /* Degradado sobrio y legal */
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Estilos de navegaci√≥n y pesta√±as */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-tab {
            padding: 15px 30px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 16px;
            border-radius: 8px; /* Aplicar bordes redondeados */
        }
        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .nav-tab.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom: 3px solid #3498db;
        }
        .tab-content {
            display: none;
            background: white;
            padding: 40px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
            border-radius: 8px;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Message Box (Reemplazo de alert) */
        .custom-message-box {
            position: fixed;
            top: -60px; /* Inicia fuera de la vista */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #3498db;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.5s ease;
            font-weight: 600;
            border-radius: 8px;
        }
        .custom-message-box.show {
            top: 20px;
            opacity: 1;
        }

        /* Estilos espec√≠ficos de Contrato y Firma */
        .contract-preview {
            background: #f8f9fa;
            padding: 30px;
            margin-top: 20px;
            border-left: 5px solid #3498db;
            border-radius: 8px;
        }
        .contract-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        .contract-header h2 {
            color: #2c3e50;
        }
        .contract-section {
            margin-bottom: 25px;
            border-left: 2px solid #ddd;
            padding-left: 15px;
        }
        .contract-section h3 {
            color: #3498db;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .contract-section p {
            line-height: 1.6;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }
        .contract-section strong {
            color: #2c3e50;
        }
        
        /* Media Queries para Responsividad mejorada */
        @media (max-width: 768px) {
            .tab-content {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 2em;
            }
            .nav-tabs {
                flex-direction: column;
                align-items: stretch;
            }
            .nav-tab {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body class="font-sans">
    <!-- Custom Message Box -->
    <div id="customMessage" class="custom-message-box"></div>

    <div class="container mx-auto p-5 md:p-10 max-w-4xl">
        <div class="header">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-3 text-white">üèõÔ∏è Acuerdo de Confidencialidad (NDA)</h1>
            <p class="text-lg opacity-90 text-white">Generador de Contratos Legales para la Protecci√≥n de Informaci√≥n</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event, 'info')">üë§ Informaci√≥n de las Partes</button>
            <button class="nav-tab" onclick="showTab(event, 'contract')">üìÑ Generar NDA</button>
            <button class="nav-tab" onclick="showTab(event, 'info_adicional')">‚ÑπÔ∏è Cl√°usulas Detalladas</button>
        </div>

        <div id="info" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">üë§ Informaci√≥n Esencial del Contrato</h2>
            <p class="mb-6 text-gray-600">Completa los datos para identificar al Divulgador y al Receptor de la Informaci√≥n Confidencial.</p>

            <form id="ndaForm">
                <h3 class="text-xl font-semibold mb-3 mt-4 text-legal-blue">Parte 1: Divulgador (Quien Revela)</h3>
                <div class="flex flex-col md:flex-row gap-5">
                    <div class="flex-1">
                        <label for="discloserName" class="block mb-2 font-semibold text-gray-700">Nombre/Raz√≥n Social:</label>
                        <input type="text" id="discloserName" name="discloserName" value="Estudio Jur√≠dico [Tu Nombre]" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                    <div class="flex-1">
                        <label for="discloserAddress" class="block mb-2 font-semibold text-gray-700">Domicilio Legal:</label>
                        <input type="text" id="discloserAddress" name="discloserAddress" value="Calle de la Ley, 123" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                </div>

                <h3 class="text-xl font-semibold mb-3 mt-8 text-legal-blue">Parte 2: Receptor (Quien Recibe y Secreta)</h3>
                <div class="flex flex-col md:flex-row gap-5">
                    <div class="flex-1">
                        <label for="recipientName" class="block mb-2 font-semibold text-gray-700">Nombre/Raz√≥n Social:</label>
                        <input type="text" id="recipientName" name="recipientName" placeholder="Ej: Tech Solutions S.A.S." class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                    <div class="flex-1">
                        <label for="recipientAddress" class="block mb-2 font-semibold text-gray-700">Domicilio Legal:</label>
                        <input type="text" id="recipientAddress" name="recipientAddress" placeholder="Ej: Avenida Innovaci√≥n, 456" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-5 mt-5">
                    <div class="flex-1">
                        <label for="agreementDate" class="block mb-2 font-semibold text-gray-700">Fecha de Vigencia (Inicio):</label>
                        <input type="date" id="agreementDate" name="agreementDate" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                    <div class="flex-1">
                        <label for="duration" class="block mb-2 font-semibold text-gray-700">Duraci√≥n de la Confidencialidad (A√±os):</label>
                        <input type="number" id="duration" name="duration" min="1" max="100" value="5" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required>
                    </div>
                </div>

                <div class="mt-5">
                    <label for="purpose" class="block mb-2 font-semibold text-gray-700">Prop√≥sito de la Revelaci√≥n (Justificaci√≥n Legal):</label>
                    <textarea id="purpose" name="purpose" placeholder="Ej: Evaluaci√≥n de una posible fusi√≥n/adquisici√≥n, consulta de un caso sensible, desarrollo de software conjunto." class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-legal-blue transition" required></textarea>
                </div>

                <button type="submit" class="btn mt-6 w-full md:w-auto p-3 text-white font-semibold rounded-lg shadow-lg bg-legal-blue hover:bg-blue-600 transition">üíæ Guardar Datos y Generar NDA</button>
            </form>

            <div id="successMessage" class="p-4 mt-6 text-sm text-blue-800 rounded-lg bg-blue-50 border border-blue-200" style="display: none;">
                ‚úÖ Datos guardados correctamente. Ahora ve a la pesta√±a **"Generar NDA"** para ver el contrato.
            </div>
        </div>

        <div id="contract" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">üìÑ Contrato de Confidencialidad (NDA) Unilateral</h2>
            <p class="mb-5 text-gray-600">Documento legal generado basado en la informaci√≥n de las partes. Debe ser firmado para su validez.</p>

            <div class="p-4 bg-gray-100 rounded-lg shadow-inner mb-6 border-l-4 border-legal-blue">
                <h3 class="text-lg font-bold text-dark-bg mb-2">üìã Resumen de T√©rminos Clave</h3>
                <div id="priceBreakdown" class="text-gray-600 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                    <div><span class="font-bold">Divulgador:</span> <span id="summaryDivulgador">---</span></div>
                    <div><span class="font-bold">Receptor:</span> <span id="summaryReceptor">---</span></div>
                    <div><span class="font-bold">Fecha de Inicio:</span> <span id="summaryDate">---</span></div>
                    <div><span class="font-bold">Vigencia:</span> <span id="summaryDuration">---</span></div>
                </div>
            </div>

            <div class="contract-preview" id="contractPreview">
                <div class="contract-header">
                    <h2>ACUERDO DE NO DIVULGACI√ìN (NDA)</h2>
                    <p>Entre **<span id="headerDiscloserName">EL DIVULGADOR</span>** y **<span id="headerRecipientName">EL RECEPTOR</span>**</p>
                </div>

                <div class="contract-section">
                    <h3>CL√ÅUSULA 1. PARTES CONTRATANTES</h3>
                    <p id="contractParties">Las partes son: **[Divulgador]** (en adelante, "Divulgador") con domicilio en [Domicilio Divulgador] y **[Receptor]** (en adelante, "Receptor") con domicilio en [Domicilio Receptor].</p>
                </div>

                <div class="contract-section">
                    <h3>CL√ÅUSULA 2. OBJETO Y PROP√ìSITO</h3>
                    <p>El objeto del presente acuerdo es proteger la Informaci√≥n Confidencial que el Divulgador revele al Receptor. El prop√≥sito de dicha revelaci√≥n es: <span id="contractPurpose"></span></p>
                </div>

                <div class="contract-section">
                    <h3>CL√ÅUSULA 3. DEFINICI√ìN DE INFORMACI√ìN CONFIDENCIAL</h3>
                    <p>Se entender√° por **"Informaci√≥n Confidencial"** cualquier dato, material, plan, secreto comercial, know-how o documento de naturaleza t√©cnica, operativa, comercial o financiera, marcado o no como confidencial, revelado en relaci√≥n con el **Prop√≥sito** antes mencionado. Se excluye informaci√≥n de dominio p√∫blico, revelada por un tercero sin obligaci√≥n de confidencialidad o conocida previamente por el Receptor.</p>
                </div>

                <div class="contract-section">
                    <h3>CL√ÅUSULA 4. OBLIGACI√ìN DE CONFIDENCIALIDAD Y USO</h3>
                    <p>El Receptor se obliga a mantener la Informaci√≥n Confidencial en el m√°s estricto secreto, utilizando el mismo grado de cuidado que utiliza para proteger su propia informaci√≥n sensible. El Receptor solo podr√° utilizar la Informaci√≥n Confidencial para el **Prop√≥sito** acordado, quedando prohibida su reproducci√≥n o divulgaci√≥n a terceros, salvo autorizaci√≥n expresa y por escrito del Divulgador o por requerimiento legal.</p>
                </div>

                <div class="contract-section">
                    <h3>CL√ÅUSULA 5. VIGENCIA Y JURISDICCI√ìN</h3>
                    <p>La obligaci√≥n de confidencialidad tendr√° una vigencia de <span id="contractDuration"></span> a√±os a partir de la fecha de inicio (<span id="contractDate"></span>). Para la resoluci√≥n de cualquier controversia derivada del presente contrato, las partes se someten a la jurisdicci√≥n de los tribunales de **[Lugar de Firmas/Jurisdicci√≥n]**.</p>
                </div>

                <div class="contract-section">
                    <h3 class="mt-8">FIRMAS</h3>
                    <div class="signature-area flex flex-col md:flex-row gap-8 mt-5">
                        <div class="signature-pad flex-1 min-w-[300px]">
                            <h4 class="font-bold text-gray-700 mb-2">Firma del Divulgador:</h4>
                            <div class="canvas-wrapper border border-gray-300 p-1 bg-white rounded-lg">
                                <canvas id="discloserSignature" width="300" height="150" class="cursor-crosshair w-full block"></canvas>
                            </div>
                            <div class="text-center mt-3">
                                <button onclick="clearSignature('discloserSignature')" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition mr-2">üóëÔ∏è Limpiar</button>
                                <button onclick="saveSignature('discloserSignature')" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition">üíæ Guardar</button>
                            </div>
                            <p class="text-center mt-3 text-xs text-gray-500">
                                Nombre: <span id="discloserNameSignature">_________________</span><br>
                                Fecha: <span id="signatureDateDiscloser">_________________</span>
                            </p>
                        </div>

                        <div class="signature-pad flex-1 min-w-[300px]">
                            <h4 class="font-bold text-gray-700 mb-2">Firma del Receptor:</h4>
                            <div class="canvas-wrapper border border-gray-300 p-1 bg-white rounded-lg">
                                <canvas id="recipientSignature" width="300" height="150" class="cursor-crosshair w-full block"></canvas>
                            </div>
                            <div class="text-center mt-3">
                                <button onclick="clearSignature('recipientSignature')" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition mr-2">üóëÔ∏è Limpiar</button>
                                <button onclick="saveSignature('recipientSignature')" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition">üíæ Guardar</button>
                            </div>
                            <p class="text-center mt-3 text-xs text-gray-500">
                                Nombre: <span id="recipientNameSignature">_________________</span><br>
                                Fecha: <span id="signatureDateRecipient">_________________</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-4">
                <button class="btn p-3 text-white font-semibold rounded-lg shadow-lg bg-legal-blue hover:bg-blue-600 transition" onclick="generateContract(true)">üîÑ Actualizar Contrato</button>
                <button class="btn p-3 text-white font-semibold rounded-lg shadow-lg bg-green-500 hover:bg-green-600 transition" onclick="generatePDF()">‚¨áÔ∏è Descargar NDA (PDF)</button>
            </div>
        </div>

        <div id="info_adicional" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">‚ÑπÔ∏è Cl√°usulas Adicionales T√≠picas del NDA</h2>
            <p class="mb-6 text-gray-600">Esta secci√≥n proporciona detalles y aclaraciones legales para un entendimiento completo del acuerdo, y tambi√©n se incluir√°n en el PDF.</p>

            <div class="contract-section">
                <h3>6. Excepciones a la Informaci√≥n Confidencial</h3>
                <p>La obligaci√≥n de confidencialidad no se aplicar√° a aquella informaci√≥n que el Receptor pueda demostrar: (a) que fue desarrollada independientemente sin utilizar la Informaci√≥n Confidencial; (b) que fue recibida de un tercero legalmente autorizado para revelarla; o (c) cuya divulgaci√≥n sea requerida por ley o una orden judicial.</p>
            </div>

            <div class="contract-section">
                <h3>7. Propiedad y Devoluci√≥n</h3>
                <p>Todo el material que contenga la Informaci√≥n Confidencial ser√° propiedad exclusiva del Divulgador. El Receptor se compromete a devolver o destruir, a petici√≥n del Divulgador, todos los documentos o copias que contengan Informaci√≥n Confidencial al finalizar el Prop√≥sito o la vigencia de este Acuerdo.</p>
            </div>

            <div class="contract-section">
                <h3>8. Incumplimiento</h3>
                <p>El Receptor reconoce que la divulgaci√≥n no autorizada de la Informaci√≥n Confidencial causar√° un da√±o irreparable al Divulgador. El Divulgador tendr√° derecho a buscar medidas cautelares y a reclamar da√±os y perjuicios por el incumplimiento de este Acuerdo.</p>
            </div>
        </div>
    </div>

    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Variables globales para datos del NDA y firmas
        let ndaData = {};
        let discloserSignatureData = null;
        let recipientSignatureData = null;
        
        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            // Asegurar que solo la primera pesta√±a est√© activa al inicio
            const firstTabButton = document.querySelector('.nav-tab');
            const firstTabContent = document.querySelector('.tab-content');
            
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            if (firstTabButton) {
                firstTabButton.classList.add('active');
            }
            if (firstTabContent) {
                firstTabContent.classList.add('active');
            }

            // Inicializar las √°reas de firma
            initializeSignaturePads();

            // Establecer la fecha actual por defecto en el formulario
            document.getElementById('agreementDate').valueAsDate = new Date();
        });

        // --- Sistema de Mensajes Personalizados (Reemplazo de alert()) ---
        function showCustomMessage(message) {
            const msgBox = document.getElementById('customMessage');
            msgBox.textContent = message;
            msgBox.classList.add('show');
            
            // Auto-ocultar despu√©s de 3 segundos
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        }

        // --- Funciones de Firma (Mejora en manejo t√°ctil y responsividad) ---

        function initializeSignaturePads() {
            const discloserCanvas = document.getElementById('discloserSignature');
            const recipientCanvas = document.getElementById('recipientSignature');
            setupSignatureCanvas(discloserCanvas);
            setupSignatureCanvas(recipientCanvas);
        }

        function setupSignatureCanvas(canvas) {
            let isDrawing = false;
            const ctx = canvas.getContext('2d');

            // Asegurar que el fondo del canvas sea blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            // Funci√≥n para mapear coordenadas de la pantalla al canvas interno (resoluci√≥n fija)
            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                let clientX = e.clientX;
                let clientY = e.clientY;

                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDrawing = (e) => {
                isDrawing = true;
                const { x, y } = getCoords(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
                // Previene el desplazamiento en m√≥viles
                if (e.cancelable) e.preventDefault(); 
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const { x, y } = getCoords(e);
                ctx.lineTo(x, y);
                ctx.stroke();
                // Previene el desplazamiento en m√≥viles
                if (e.cancelable) e.preventDefault(); 
            };

            const stopDrawing = () => {
                isDrawing = false;
            };

            // Eventos de rat√≥n
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Eventos t√°ctiles (usando passive: false para prevenir scroll)
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing, { passive: false });
        }

        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Volver a dibujar el fondo blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Limpiar datos de firma guardados
            if (canvasId === 'discloserSignature') {
                discloserSignatureData = null;
                document.getElementById('signatureDateDiscloser').textContent = '_________________';
            } else {
                recipientSignatureData = null;
                document.getElementById('signatureDateRecipient').textContent = '_________________';
            }
            showCustomMessage('üóëÔ∏è Firma borrada.');
        }

        function saveSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            // 1. Verificar si hay contenido (revisando si el canvas es completamente blanco)
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let hasContent = false;
                // Buscamos cualquier p√≠xel que no sea completamente blanco
                for (let i = 0; i < imageData.data.length; i += 4) {
                    // Si el color no es 255, 255, 255 (blanco) O el alfa no es 0
                    if (imageData.data[i] !== 255 || imageData.data[i+1] !== 255 || imageData.data[i+2] !== 255) {
                        hasContent = true;
                        break;
                    }
                }
                
                if (!hasContent) {
                    showCustomMessage('‚ö†Ô∏è Por favor, dibuja la firma antes de guardar.');
                    return;
                }
            } catch (e) {
                console.error("Error al verificar la imagen del canvas: ", e);
                showCustomMessage('‚ö†Ô∏è Error al verificar la firma. Int√©ntalo de nuevo.');
                return;
            }

            const signatureData = canvas.toDataURL('image/png');
            const currentDate = new Date().toLocaleDateString('es-ES');

            if (canvasId === 'discloserSignature') {
                discloserSignatureData = signatureData;
                document.getElementById('signatureDateDiscloser').textContent = currentDate;
                document.getElementById('discloserNameSignature').textContent = ndaData.discloserName || 'Divulgador';
                showCustomMessage('‚úÖ Firma del Divulgador guardada correctamente');
            } else {
                recipientSignatureData = signatureData;
                document.getElementById('signatureDateRecipient').textContent = currentDate;
                document.getElementById('recipientNameSignature').textContent = ndaData.recipientName || 'Receptor';
                showCustomMessage('‚úÖ Firma del Receptor guardada correctamente');
            }
        }

        // --- Funciones de Navegaci√≥n y Datos ---

        function showTab(event, tabName) {
            // Ocultar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');

            // Actualizar botones de navegaci√≥n
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        document.getElementById('ndaForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            ndaData = {};

            // Obtener datos del formulario
            for (let [key, value] of formData.entries()) {
                ndaData[key] = value;
            }

            // Generar contenido del contrato
            generateContract();
            
            // Mostrar mensaje de √©xito
            document.getElementById('successMessage').style.display = 'block';
            showCustomMessage('‚úÖ Datos guardados. Revisa la pesta√±a NDA.');
        });

        function generateContract(manualClick = false) {
            if (!ndaData.discloserName || !ndaData.recipientName) {
                if (manualClick) {
                    showCustomMessage('‚ö†Ô∏è Por favor, completa primero la informaci√≥n de las partes.');
                }
                return;
            }

            const date = ndaData.agreementDate;
            const duration = ndaData.duration;
            const purpose = ndaData.purpose;
            const discloser = ndaData.discloserName;
            const recipient = ndaData.recipientName;
            const discloserAddress = ndaData.discloserAddress;
            const recipientAddress = ndaData.recipientAddress;

            // 1. Actualizar Encabezado
            document.getElementById('headerDiscloserName').textContent = discloser.toUpperCase();
            document.getElementById('headerRecipientName').textContent = recipient.toUpperCase();

            // 2. Actualizar Cl√°usulas del Contrato
            document.getElementById('contractParties').innerHTML = `Las partes son: <strong>${discloser}</strong> (en adelante, "Divulgador") con domicilio en ${discloserAddress} y <strong>${recipient}</strong> (en adelante, "Receptor") con domicilio en ${recipientAddress}.`;
            document.getElementById('contractPurpose').textContent = purpose;
            document.getElementById('contractDuration').textContent = duration;
            document.getElementById('contractDate').textContent = new Date(date).toLocaleDateString('es-ES');

            // 3. Actualizar Nombres de Firmas (solo si no se han guardado las firmas)
            if (!discloserSignatureData) {
                document.getElementById('discloserNameSignature').textContent = discloser;
            }
            if (!recipientSignatureData) {
                document.getElementById('recipientNameSignature').textContent = recipient;
            }

            // 4. Actualizar Resumen
            document.getElementById('summaryDivulgador').textContent = discloser;
            document.getElementById('summaryReceptor').textContent = recipient;
            document.getElementById('summaryDate').textContent = new Date(date).toLocaleDateString('es-ES');
            document.getElementById('summaryDuration').textContent = `${duration} a√±os`;

            if (manualClick) {
                showCustomMessage('üîÑ Contrato actualizado con los √∫ltimos datos.');
            }
        }

        // --- Funciones de PDF (L√≥gica completada) ---

        function generatePDF() {
            if (!ndaData.discloserName || !ndaData.recipientName) {
                showCustomMessage('‚ö†Ô∏è Primero debe guardar la informaci√≥n de las partes y generar el contrato.');
                return;
            }

            // 1. Asegurarse de que el contrato est√© generado
            generateContract(false);
            
            // 2. Inicializar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // 'p'ortrait, 'mm', A4
            
            const contractElement = document.getElementById('contractPreview');
            
            const margin = 20;
            let y = margin;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const textWidth = pageWidth - 2 * margin; // 170mm for A4 with 20mm margin

            // --- T√≠tulo Principal ---
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("ACUERDO DE CONFIDENCIALIDAD (NDA)", pageWidth / 2, y, { align: "center" });
            y += 10;
            doc.setFontSize(10);
            doc.text(`Divulgador: ${ndaData.discloserName} | Receptor: ${ndaData.recipientName}`, pageWidth / 2, y, { align: "center" });
            y += 15;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");

            // --- Contenido de Cl√°usulas (Cl√°usula 1 a 5) y Adicionales (6 a 8) ---
            const mainContractSections = contractElement.querySelectorAll('.contract-section');
            const additionalInfoElement = document.getElementById('info_adicional');
            const additionalSections = additionalInfoElement.querySelectorAll('.contract-section');

            const allSections = [...mainContractSections, ...additionalSections];

            allSections.forEach(section => {
                const title = section.querySelector('h3');
                if (!title || title.textContent.includes('FIRMAS')) return; // Saltar secci√≥n de firmas aqu√≠

                // T√≠tulo de la secci√≥n
                doc.setFont("helvetica", "bold");
                doc.setTextColor(52, 152, 219); // Azul legal
                y += 7;

                // Comprobar salto de p√°gina para el t√≠tulo
                if (y + 10 > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }

                const titleLines = doc.splitTextToSize(title.textContent.toUpperCase(), textWidth);
                doc.text(titleLines, margin, y);
                y += (titleLines.length * 5) + 3; // Mover hacia abajo
                
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0); // Volver a negro

                // P√°rrafos
                const paragraphs = section.querySelectorAll('p');
                paragraphs.forEach(p => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = p.innerHTML.replace(/<strong>/g, '**').replace(/<\/strong>/g, '**'); // Convertir strong a Markdown simple para negritas

                    let textContent = tempDiv.textContent || tempDiv.innerText;
                    
                    // Reemplazo manual de negritas (jsPDF tiene una limitaci√≥n en estilos inline)
                    // Para simplicidad, solo usamos el texto limpio.
                    
                    const lines = doc.splitTextToSize(textContent, textWidth);

                    // Comprobar salto de p√°gina antes del p√°rrafo
                    if (y + (lines.length * 6) + 3 > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.text(lines, margin, y);
                    y += (lines.length * 6) + 3; // 6 mm de alto de l√≠nea + 3 mm de espacio
                });
            });

            // --- Secci√≥n de Firmas ---
            y += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");

            if (y + 10 > pageHeight - margin) {
                doc.addPage();
                y = margin;
            }

            doc.text("CL√ÅUSULA FINAL. FIRMAS", margin, y);
            y += 10;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Las partes firman digitalmente el presente Acuerdo de Confidencialidad en la fecha indicada a continuaci√≥n, aceptando la totalidad de sus t√©rminos y condiciones.", margin, y);
            y += 15;


            // Configuraci√≥n de layout de firmas en PDF
            const sigY = y;
            const sigWidth = 60; // Ancho de la imagen de firma en mm
            const sigHeight = 30; // Alto de la imagen de firma en mm
            const spaceBetween = 20; // Espacio entre las dos √°reas de firma
            const recipientX = margin + sigWidth + spaceBetween;

            // Comprobar si hay espacio para ambas firmas
            if (sigY + sigHeight + 20 > pageHeight - margin) {
                doc.addPage();
                y = margin;
                sigY = y;
            }
            
            // 1. Divulgador Signature
            doc.setFont("helvetica", "bold");
            doc.text("DIVULGADOR:", margin, sigY);
            doc.setFont("helvetica", "normal");
            
            let currentSigY = sigY + 5;
            if (discloserSignatureData) {
                doc.addImage(discloserSignatureData, 'PNG', margin, currentSigY, sigWidth, sigHeight);
                currentSigY += sigHeight + 5;
                doc.text(`Nombre: ${ndaData.discloserName}`, margin, currentSigY);
                doc.text(`Fecha: ${document.getElementById('signatureDateDiscloser').textContent}`, margin, currentSigY + 5);
            } else {
                doc.text("________________________________", margin, currentSigY + 15);
                currentSigY += 25;
                doc.text(`Nombre: ${ndaData.discloserName}`, margin, currentSigY + 5);
                doc.text(`Fecha: No firmada`, margin, currentSigY + 10);
            }
            
            // 2. Receptor Signature
            doc.setFont("helvetica", "bold");
            doc.text("RECEPTOR:", recipientX, sigY);
            doc.setFont("helvetica", "normal");
            
            currentSigY = sigY + 5;
            if (recipientSignatureData) {
                doc.addImage(recipientSignatureData, 'PNG', recipientX, currentSigY, sigWidth, sigHeight);
                currentSigY += sigHeight + 5;
                doc.text(`Nombre: ${ndaData.recipientName}`, recipientX, currentSigY);
                doc.text(`Fecha: ${document.getElementById('signatureDateRecipient').textContent}`, recipientX, currentSigY + 5);
            } else {
                doc.text("________________________________", recipientX, currentSigY + 15);
                currentSigY += 25;
                doc.text(`Nombre: ${ndaData.recipientName}`, recipientX, currentSigY + 5);
                doc.text(`Fecha: No firmada`, recipientX, currentSigY + 10);
            }


            // 3. Final save/download
            const discloserNameSafe = ndaData.discloserName.replace(/[^\w\s]/gi, '').trim().substring(0, 15);
            const recipientNameSafe = ndaData.recipientName.replace(/[^\w\s]/gi, '').trim().substring(0, 15);
            doc.save(`NDA_${discloserNameSafe}_vs_${recipientNameSafe}.pdf`);
            showCustomMessage('üìÑ NDA descargado con √©xito!');
        }
    </script>
</body>
</html>
