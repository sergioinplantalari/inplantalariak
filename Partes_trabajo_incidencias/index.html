<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parte de Incidencias - Autobuses</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .form-container {
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-group input[type="text"],
    .form-group input[type="time"],
    .form-group textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e6ed;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #3498db;
    }

    .signature-section {
      margin: 30px 0;
    }

    #firmaCanvas {
      border: 3px dashed #3498db;
      border-radius: 10px;
      width: 100%;
      height: 200px;
      cursor: crosshair;
      background: white;
      transition: border-color 0.3s ease;
    }

    #firmaCanvas:hover {
      border-color: #2980b9;
    }

    .image-section {
      margin: 30px 0;
    }

    .image-upload-area {
      border: 3px dashed #27ae60;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .image-upload-area:hover {
      border-color: #229954;
      background: #e8f5e8;
    }

    .image-upload-area.dragover {
      border-color: #27ae60;
      background: #d5f4e6;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3em;
      color: #27ae60;
      margin-bottom: 15px;
    }

    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .image-item {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .image-item:hover {
      transform: scale(1.05);
    }

    .image-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background 0.3s ease;
    }

    .remove-image:hover {
      background: #c0392b;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      padding: 15px 25px;
      border: none;
      border-radius: 50px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white;
      box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-camera {
      background: linear-gradient(135deg, #e67e22, #d35400);
      color: white;
      box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .hidden {
      display: none;
    }

    .camera-container {
      position: relative;
      margin: 20px 0;
    }

    #camera-video {
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }
      
      .form-container {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .button-group {
        grid-template-columns: 1fr;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöå Parte de Incidencias</h1>
      <p>Sistema de registro de incidencias para autobuses</p>
    </div>
    
    <div class="form-container">
      <div class="form-group">
        <label for="conductor">üë§ Conductor</label>
        <input type="text" id="conductor" placeholder="Nombre del conductor">
      </div>

      <div class="form-group">
        <label for="matricula">üöó Matr√≠cula</label>
        <input type="text" id="matricula" placeholder="Matr√≠cula del veh√≠culo">
      </div>

      <div class="form-group">
        <label for="tiempo">‚è∞ Hora</label>
        <input type="time" id="tiempo">
      </div>

      <div class="form-group">
        <label for="incidencia">üìù Descripci√≥n de la Incidencia</label>
        <textarea id="incidencia" rows="4" placeholder="Describe detalladamente la incidencia ocurrida..."></textarea>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="resuelto">
          <label for="resuelto">‚úÖ Incidencia Resuelta</label>
        </div>
      </div>

      <div class="image-section">
        <label>üì∏ Im√°genes de la Incidencia</label>
        <div class="image-upload-area" onclick="document.getElementById('file-input').click()">
          <div class="upload-icon">üìÅ</div>
          <h3>Seleccionar im√°genes</h3>
          <p>Haz clic aqu√≠ o arrastra las im√°genes</p>
        </div>
        <input type="file" id="file-input" multiple accept="image/*" class="hidden">
        
        <div class="button-group" style="margin-top: 15px;">
          <button class="btn btn-camera" onclick="abrirCamara()">üì∑ Tomar Foto</button>
        </div>

        <div class="camera-container hidden" id="camera-container">
          <video id="camera-video" autoplay></video>
          <div class="camera-controls">
            <button class="btn btn-success" onclick="tomarFoto()">üì∏ Capturar</button>
            <button class="btn btn-secondary" onclick="cerrarCamara()">‚ùå Cerrar</button>
          </div>
        </div>

        <div class="image-preview" id="image-preview"></div>
      </div>

      <div class="signature-section">
        <label>‚úçÔ∏è Firma Digital</label>
        <canvas id="firmaCanvas"></canvas>
        <div class="button-group" style="margin-top: 15px;">
          <button class="btn btn-secondary" onclick="limpiarFirma()">üóëÔ∏è Limpiar Firma</button>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="generarPDF()" id="pdf-btn">
          üìÑ Generar PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    const canvas = document.getElementById('firmaCanvas');
    const ctx = canvas.getContext('2d');
    let firmando = false;
    let imagenes = [];
    let stream = null;

    // Configurar canvas para alta resoluci√≥n
    function setupCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#2c3e50';
    }

    // Inicializar canvas
    window.addEventListener('load', setupCanvas);
    window.addEventListener('resize', setupCanvas);

    // Funcionalidad de firma
    canvas.addEventListener('mousedown', iniciarFirma);
    canvas.addEventListener('mousemove', dibujar);
    canvas.addEventListener('mouseup', finalizarFirma);
    canvas.addEventListener('mouseout', finalizarFirma);

    // Soporte t√°ctil
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      const mouseEvent = new MouseEvent('mouseup', {});
      canvas.dispatchEvent(mouseEvent);
    });

    function iniciarFirma(e) {
      firmando = true;
      const rect = canvas.getBoundingClientRect();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function dibujar(e) {
      if (!firmando) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#2c3e50';
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function finalizarFirma() {
      firmando = false;
      ctx.beginPath();
    }

    function limpiarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
    }

    // Funcionalidad de im√°genes
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.querySelector('.image-upload-area');
    const imagePreview = document.getElementById('image-preview');

    fileInput.addEventListener('change', manejarArchivos);

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      procesarImagenes(files);
    });

    function manejarArchivos(e) {
      const files = Array.from(e.target.files);
      procesarImagenes(files);
    }

    function procesarImagenes(files) {
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = {
              id: Date.now() + Math.random(),
              src: e.target.result,
              name: file.name
            };
            imagenes.push(img);
            mostrarImagenes();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function mostrarImagenes() {
      imagePreview.innerHTML = '';
      imagenes.forEach(img => {
        const div = document.createElement('div');
        div.className = 'image-item';
        div.innerHTML = `
          <img src="${img.src}" alt="${img.name}">
          <button class="remove-image" onclick="eliminarImagen(${img.id})">√ó</button>
        `;
        imagePreview.appendChild(div);
      });
    }

    function eliminarImagen(id) {
      imagenes = imagenes.filter(img => img.id !== id);
      mostrarImagenes();
    }

    // Funcionalidad de c√°mara
    async function abrirCamara() {
      try {
        // Verificar si el navegador soporta getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Tu navegador no soporta el acceso a la c√°mara. Por favor, usa un navegador moderno como Chrome, Firefox o Safari.');
          return;
        }

        // Solicitar permisos de c√°mara
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: { ideal: 'environment' }
          },
          audio: false
        });
        
        const video = document.getElementById('camera-video');
        video.srcObject = stream;
        document.getElementById('camera-container').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error al acceder a la c√°mara:', error);
        let mensaje = 'Error al acceder a la c√°mara: ';
        
        if (error.name === 'NotAllowedError') {
          mensaje += 'Permisos de c√°mara denegados. Por favor, permite el acceso a la c√°mara y recarga la p√°gina.';
        } else if (error.name === 'NotFoundError') {
          mensaje += 'No se encontr√≥ ninguna c√°mara en el dispositivo.';
        } else if (error.name === 'NotSupportedError') {
          mensaje += 'Tu navegador no soporta el acceso a la c√°mara.';
        } else {
          mensaje += error.message;
        }
        
        alert(mensaje);
      }
    }

    function tomarFoto() {
      const video = document.getElementById('camera-video');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      const dataURL = canvas.toDataURL('image/jpeg', 0.8);
      const img = {
        id: Date.now(),
        src: dataURL,
        name: `Foto_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`
      };
      
      imagenes.push(img);
      mostrarImagenes();
      cerrarCamara();
    }

    function cerrarCamara() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('camera-container').classList.add('hidden');
    }

    // Generar PDF
    function generarPDF() {
      const btn = document.getElementById('pdf-btn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span class="loading"></span> Generando PDF...';
      btn.disabled = true;

      // Usar setTimeout para permitir que la UI se actualice
      setTimeout(() => {
        try {
          const conductor = document.getElementById('conductor').value;
          const matricula = document.getElementById('matricula').value;
          const tiempo = document.getElementById('tiempo').value;
          const incidencia = document.getElementById('incidencia').value;
          const resuelto = document.getElementById('resuelto').checked ? 'S√≠' : 'No';
          const fechaHora = new Date().toLocaleString('es-ES');
          const firmaImg = canvas.toDataURL("image/png");

          let imagenesHTML = '';
          if (imagenes.length > 0) {
            imagenesHTML = '<p><strong>IM√ÅGENES:</strong></p><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0;">';
            imagenes.forEach((img, index) => {
              imagenesHTML += `<div><img src="${img.src}" style="width: 100%; max-width: 250px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><p style="text-align: center; font-size: 0.8em; margin-top: 5px;">Imagen ${index + 1}</p></div>`;
            });
            imagenesHTML += '</div>';
          }

          const contenido = `
            <div style="font-family: 'Arial', sans-serif; color: #2c3e50; line-height: 1.6; max-width: 800px; margin: 0 auto;">
              <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: #3498db; color: white; border-radius: 10px;">
                <h1 style="margin: 0; font-size: 2.2em;">üöå PARTE DE INCIDENCIAS</h1>
                <p style="margin: 10px 0 0 0; font-size: 1.1em;">Fecha y Hora: ${fechaHora}</p>
                <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: bold;">Matr√≠cula: ${matricula}</p>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                  <p style="margin: 0;"><strong>üë§ CONDUCTOR:</strong></p>
                  <p style="margin: 5px 0 0 0; font-style: italic; color: #555;">${conductor}</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                  <p style="margin: 0;"><strong>‚è∞ HORA:</strong></p>
                  <p style="margin: 5px 0 0 0; font-style: italic; color: #555;">${tiempo}</p>
                </div>
              </div>

              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #e74c3c;">
                <p style="margin: 0;"><strong>üìù DESCRIPCI√ìN DE LA INCIDENCIA:</strong></p>
                <p style="margin: 10px 0 0 0; font-style: italic; color: #555; white-space: pre-wrap;">${incidencia}</p>
              </div>

              <div style="background: ${resuelto === 'S√≠' ? '#d5f4e6' : '#fdf2e9'}; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid ${resuelto === 'S√≠' ? '#27ae60' : '#f39c12'};">
                <p style="margin: 0;"><strong>${resuelto === 'S√≠' ? '‚úÖ' : '‚ö†Ô∏è'} ESTADO:</strong></p>
                <p style="margin: 5px 0 0 0; font-weight: bold; color: ${resuelto === 'S√≠' ? '#27ae60' : '#f39c12'};">${resuelto === 'S√≠' ? 'INCIDENCIA RESUELTA' : 'PENDIENTE DE RESOLUCI√ìN'}</p>
              </div>

              ${imagenesHTML}

              <div style="margin-top: 30px;">
                <p style="margin: 0;"><strong>‚úçÔ∏è FIRMA:</strong></p>
                <div style="text-align: center; margin-top: 15px;">
                  <img src="${firmaImg}" style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px; background: white;">
                </div>
              </div>

              <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ecf0f1; text-align: center; color: #7f8c8d; font-size: 0.9em;">
                <p>Documento generado autom√°ticamente el ${fechaHora}</p>
              </div>
            </div>
          `;

          const opt = {
            margin: 1,
            filename: `Incidencia_${fechaHora.replace(/[/:]/g, '-')}_${matricula}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2,
              useCORS: true,
              allowTaint: true,
              logging: false,
              width: 800,
              height: 1200
            },
            jsPDF: { 
              unit: 'mm', 
              format: 'a4', 
              orientation: 'portrait' 
            }
          };

          html2pdf().from(contenido).set(opt).save().then(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
          }).catch((error) => {
            console.error('Error generando PDF:', error);
            alert('Error al generar el PDF. Por favor, int√©ntalo de nuevo.');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
          });
          
        } catch (error) {
          console.error('Error generando PDF:', error);
          alert('Error al generar el PDF: ' + error.message);
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      }, 100);
    }

    // Inicializar tiempo actual
    document.getElementById('tiempo').value = new Date().toTimeString().slice(0, 5);
  </script>
</body>
</html>